{% extends 'base.html' %}
{% block title %}My Bookings - SkillLink{% endblock %}

{% block content %}
<div class="container mt-5 max-w-4xl">

  <h1 class="text-center mb-5 fw-bold animate__animated animate__fadeInDown headings-color">My Bookings</h1>

  {# --- Incoming Bookings (Provider) --- #}
  <h2 class="fw-semibold mb-3 animate__animated animate__fadeInLeft headings-color">Incoming Booking Requests</h2>
  {% for booking in bookings_received %}
  <div class="card shadow mb-4 animate__animated animate__fadeInUp booking-card" id="booking-card-{{ booking.id }}">
    <div class="card-body">
      <p><strong>Skill:</strong> {{ booking.skill.name }}</p>
      <p><strong>Status:</strong> <span class="badge bg-info text-dark status-badge">{{ booking.status|capfirst }}</span></p>
      <p><strong>Requester:</strong> {{ booking.requester.user.get_full_name|default:booking.requester.user.username }}
      </p>

      <p><strong>Proposed Times:</strong></p>
      <ul>
        {% for h in booking.history.all %}
        <li>{{ h.proposed_time|date:"D, d M Y h:i A" }}</li>
        {% endfor %}
      </ul>

      <div class="d-flex flex-wrap gap-2 mt-2">
        {% if booking.status == 'pending' %}
        <a href="{% url 'schedule_meeting' booking.id %}" class="btn btn-success fw-bold shadow-sm">Accept &
          Schedule</a>
        <a href="{% url 'booking_update_status' booking.id 'reject' %}"
          class="btn btn-danger fw-bold shadow-sm">Reject</a>
        {% elif booking.status == 'scheduled' %}
        {% if booking.provider.user == user %}
        <a href="{% url 'start_meeting' booking.id %}" target="_blank" class="btn btn-primary fw-bold shadow-sm">Start
          Zoom</a>
        <a href="{% url 'booking_details' booking.id %}" class="btn btn-info fw-bold shadow-sm">Chat</a>
        {% elif booking.requester.user == user %}
        {% if booking.meeting_started %}
        <a href="{{ booking.meeting_link }}" target="_blank" class="btn btn-success fw-bold shadow-sm">Join Zoom</a>
        {% else %}
        <p class="fw-semibold waiting-text">Waiting for host to start the meeting...</p>
        {% endif %}
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% empty %}
  <p class="mb-4 headings-color">No incoming bookings.</p>
  {% endfor %}

  {# --- My Bookings (Requester) --- #}
  <h2 class="fw-semibold mb-3 mt-5 animate__animated animate__fadeInLeft headings-color">My Bookings (Requested)</h2>
  {% for booking in bookings_made %}
  <div class="card shadow mb-4 animate__animated animate__fadeInUp booking-card" id="booking-card-{{ booking.id }}">
    <div class="card-body">
      <p><strong>Skill:</strong> {{ booking.skill.name }}</p>
      <p><strong>Status:</strong> <span class="badge bg-info text-dark status-badge">{{ booking.status|capfirst }}</span></p>
      <p><strong>Provider:</strong> {{ booking.provider.user.get_full_name|default:booking.provider.user.username }}</p>

      <p><strong>Proposed Times:</strong></p>
      <ul>
        {% for h in booking.history.all %}
        <li>{{ h.proposed_time|date:"D, d M Y h:i A" }}</li>
        {% endfor %}
      </ul>

      <div class="d-flex flex-wrap gap-2 mt-2">
        {% if booking.status == 'pending' %}
        <a href="{% url 'booking_update_status' booking.id 'cancel' %}"
          class="btn btn-warning fw-bold shadow-sm">Cancel</a>
        {% elif booking.status == 'scheduled' %}
        {% if booking.requester.user == user %}
        {% if booking.meeting_started %}
        <a href="{{ booking.meeting_link }}" target="_blank" class="btn btn-success fw-bold shadow-sm">Join Zoom</a>
        <a href="{% url 'booking_details' booking.id %}" class="btn btn-info fw-bold shadow-sm">Chat</a>
        {% else %}
        <p class="fw-semibold waiting-text">Waiting for host to start the meeting...</p>
        <a href="{% url 'booking_details' booking.id %}" class="btn btn-info fw-bold shadow-sm">Chat</a>
        {% endif %}
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% empty %}
  <p class="headings-color">No bookings made yet.</p>
  {% endfor %}

</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Review your session</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="reviewForm" method="POST">
        {% csrf_token %}
        <div class="modal-body">
          <p id="reviewSkillName"></p>

          <!-- Review Fields -->
          <div id="reviewFields">
            <div class="mb-3">
              <label class="form-label">Rating (1-5)</label>
              <div class="star-rating">
                <input type="radio" name="rating" value="5" id="star5"><label for="star5">★</label>
                <input type="radio" name="rating" value="4" id="star4"><label for="star4">★</label>
                <input type="radio" name="rating" value="3" id="star3"><label for="star3">★</label>
                <input type="radio" name="rating" value="2" id="star2"><label for="star2">★</label>
                <input type="radio" name="rating" value="1" id="star1"><label for="star1">★</label>
              </div>
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label">Comment (optional)</label>
              <textarea class="form-control" name="comment" id="comment" rows="3"></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-link text-danger p-0" id="showReportBtn">Report Mentor
                instead?</button>
            </div>
          </div>

          <!-- Report Fields (hidden by default) -->
          <div id="reportFields" style="display: none;">
            <div class="mb-3">
              <label for="reason" class="form-label text-danger">Reason for reporting</label>
              <textarea class="form-control border-danger" name="reason" id="reason" rows="3"
                placeholder="Please describe the issue..."></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-link text-primary p-0" id="backToReviewBtn">Back to Review</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Submit Review</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="ratings-data" style="display:none;">
  {% for booking in bookings_made %}
  {% if booking.review_pending %}
  <div class="pending-review" data-id="{{ booking.id }}" data-skill="{{ booking.skill.name }}"></div>
  {% endif %}
  {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const pendingReviews = document.querySelectorAll('.pending-review');
    if (pendingReviews.length > 0) {
      const reviewDiv = pendingReviews[0];
      const bookingId = reviewDiv.getAttribute('data-id');
      const skillName = reviewDiv.getAttribute('data-skill');

      const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
      const reviewForm = document.getElementById('reviewForm');
      const reviewSkillName = document.getElementById('reviewSkillName');

      reviewForm.action = `/meetings/${bookingId}/submit_review/`;
      reviewSkillName.innerHTML = `How was your session for <strong>${skillName}</strong>?`;

      const showReportBtn = document.getElementById('showReportBtn');
      const backToReviewBtn = document.getElementById('backToReviewBtn');
      const reviewFields = document.getElementById('reviewFields');
      const reportFields = document.getElementById('reportFields');
      const submitBtn = document.getElementById('submitBtn');

      showReportBtn.addEventListener('click', () => {
        reviewFields.style.display = 'none';
        reportFields.style.display = 'block';
        submitBtn.textContent = 'Submit Report';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-danger');
        reviewForm.action = `/meetings/${bookingId}/report/`;
      });

      backToReviewBtn.addEventListener('click', () => {
        reviewFields.style.display = 'block';
        reportFields.style.display = 'none';
        submitBtn.textContent = 'Submit Review';
        submitBtn.classList.remove('btn-danger');
        submitBtn.classList.add('btn-primary');
        reviewForm.action = `/meetings/${bookingId}/submit_review/`;
      });

      reviewModal.show();
    }
  });

  window.addEventListener('bookingStatusChanged', function (e) {
    const data = e.detail;
    const card = document.getElementById(`booking-card-${data.booking_id}`);
    if (card) {
      const badge = card.querySelector('.status-badge');
      if (badge) {
        badge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
      }
      card.classList.add('animate__animated', 'animate__pulse');
    }
  });
</script>

<style>
  /* Base Card Style (Light Mode) */
  .booking-card {
    border: 2px solid #F0E68C;
    background-color: #FFF8DC;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    color: #212529;
    /* Default bootstrap dark text */
  }

  .booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  }

  .headings-color {
    color: #212529;
  }

  .waiting-text {
    color: #212529;
  }

  /* Dark Mode Overrides */
  body.dark-mode .headings-color {
    color: #f5f5f5 !important;
  }

  body.dark-mode .booking-card {
    background-color: #1a1a1a;
    border: 2px solid #333;
    color: #e0e0e0;
  }

  body.dark-mode .booking-card:hover {
    box-shadow: 0 10px 25px rgba(255, 255, 255, 0.1);
  }

  body.dark-mode .waiting-text {
    color: #ccc;
  }

  /* Ensure status badges remain readable */
  /* .badge.bg-info.text-dark is explicitly black text on light blue bg, keeping it is usually fine */


  .btn {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  .badge {
    font-size: 0.85rem;
    border-radius: 12px;
    padding: 0.35em 0.7em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .animate__animated {
    --animate-duration: 0.8s;
  }

  /* Star Rating Styles */
  .star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    font-size: 2rem;
  }

  .star-rating input {
    display: none;
  }

  .star-rating label {
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s;
  }

  .star-rating input:checked~label,
  .star-rating label:hover,
  .star-rating label:hover~label {
    color: #ffc107;
  }

  /* Modal Dark Mode Overrides */
  body.dark-mode .modal-content {
    background-color: #1a1a1a;
    border: 1px solid #444;
    color: #e0e0e0;
  }

  body.dark-mode .modal-header,
  body.dark-mode .modal-footer {
    border-color: #333;
  }

  body.dark-mode .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
  }

  body.dark-mode .form-label {
    color: #e0e0e0;
  }

  body.dark-mode .form-control {
    background-color: #2a2a2a;
    border: 1px solid #444;
    color: #e0e0e0;
  }

  body.dark-mode .form-control:focus {
    background-color: #2a2a2a;
    border-color: #f1c40f;
    color: #fff;
  }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
{% endblock %}