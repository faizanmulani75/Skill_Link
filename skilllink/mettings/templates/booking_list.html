{% extends 'base.html' %}
{% block title %}My Bookings - SkillLink{% endblock %}

{% block content %}
<div class="container mt-5 max-w-4xl">

  <h1 class="text-center mb-5 fw-bold animate__animated animate__fadeInDown headings-color">My Bookings</h1>

  {# --- Incoming Bookings (Provider) --- #}
  <h2 class="fw-semibold mb-3 animate__animated animate__fadeInLeft headings-color">Incoming Booking Requests</h2>
  <div id="incoming-bookings-list">
    {% for booking in bookings_received %}
    {% include 'includes/booking_card.html' with booking=booking %}
    {% empty %}
    <p class="mb-4 headings-color empty-msg">No incoming bookings.</p>
    {% endfor %}
  </div>

  {# --- My Bookings (Requester) --- #}
  <h2 class="fw-semibold mb-3 mt-5 animate__animated animate__fadeInLeft headings-color">My Bookings (Requested)</h2>
  <div id="my-bookings-list">
    {% for booking in bookings_made %}
    {% include 'includes/booking_card.html' with booking=booking %}
    {% empty %}
    <p class="headings-color empty-msg">No bookings made yet.</p>
    {% endfor %}
  </div>

</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Review your session</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="reviewForm" method="POST">
        {% csrf_token %}
        <div class="modal-body">
          <p id="reviewSkillName"></p>

          <!-- Review Fields -->
          <div id="reviewFields">
            <div class="mb-3">
              <label class="form-label">Rating (1-5)</label>
              <div class="star-rating">
                <input type="radio" name="rating" value="5" id="star5"><label for="star5">★</label>
                <input type="radio" name="rating" value="4" id="star4"><label for="star4">★</label>
                <input type="radio" name="rating" value="3" id="star3"><label for="star3">★</label>
                <input type="radio" name="rating" value="2" id="star2"><label for="star2">★</label>
                <input type="radio" name="rating" value="1" id="star1"><label for="star1">★</label>
              </div>
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label">Comment (optional)</label>
              <textarea class="form-control" name="comment" id="comment" rows="3"></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-link text-danger p-0" id="showReportBtn">Report Mentor
                instead?</button>
            </div>
          </div>

          <!-- Report Fields (hidden by default) -->
          <div id="reportFields" style="display: none;">
            <div class="mb-3">
              <label for="reason" class="form-label text-danger">Reason for reporting</label>
              <textarea class="form-control border-danger" name="reason" id="reason" rows="3"
                placeholder="Please describe the issue..."></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-link text-primary p-0" id="backToReviewBtn">Back to Review</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Submit Review</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="ratings-data" style="display:none;">
  {% for booking in bookings_made %}
  {% if booking.review_pending %}
  <div class="pending-review" data-id="{{ booking.id }}" data-skill="{{ booking.skill.name }}"></div>
  {% endif %}
  {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const pendingReviews = document.querySelectorAll('.pending-review');
    if (pendingReviews.length > 0) {
      const reviewDiv = pendingReviews[0];
      const bookingId = reviewDiv.getAttribute('data-id');
      const skillName = reviewDiv.getAttribute('data-skill');

      const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
      const reviewForm = document.getElementById('reviewForm');
      const reviewSkillName = document.getElementById('reviewSkillName');

      reviewForm.action = `/meetings/${bookingId}/submit_review/`;
      reviewSkillName.innerHTML = `How was your session for <strong>${skillName}</strong>?`;

      const showReportBtn = document.getElementById('showReportBtn');
      const backToReviewBtn = document.getElementById('backToReviewBtn');
      const reviewFields = document.getElementById('reviewFields');
      const reportFields = document.getElementById('reportFields');
      const submitBtn = document.getElementById('submitBtn');

      showReportBtn.addEventListener('click', () => {
        reviewFields.style.display = 'none';
        reportFields.style.display = 'block';
        submitBtn.textContent = 'Submit Report';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-danger');
        reviewForm.action = `/meetings/${bookingId}/report/`;
      });

      backToReviewBtn.addEventListener('click', () => {
        reviewFields.style.display = 'block';
        reportFields.style.display = 'none';
        submitBtn.textContent = 'Submit Review';
        submitBtn.classList.remove('btn-danger');
        submitBtn.classList.add('btn-primary');
        reviewForm.action = `/meetings/${bookingId}/submit_review/`;
      });

      reviewModal.show();
    }
  });


  window.addEventListener('newBookingRequest', function (e) {
    const data = e.detail;


    let listId = 'incoming-bookings-list';
    if (data.role === 'requester') {
      listId = 'my-bookings-list';
    }

    const list = document.getElementById(listId);


    fetch(`/meetings/render_card/${data.booking_id}/`)
      .then(response => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
      })
      .then(html => {
        if (list) {

          const emptyMsg = list.querySelector('.empty-msg');
          if (emptyMsg) emptyMsg.remove();

          const div = document.createElement('div');
          div.innerHTML = html;
          const newCard = div.firstElementChild;


          newCard.classList.add('animate__animated', 'animate__fadeInDown');
          list.prepend(newCard);
        }
      })
      .catch(err => console.error("Error fetching new booking card:", err));
  });


  window.addEventListener('bookingStatusChanged', function (e) {
    const data = e.detail;
    console.log("Booking Update Received:", data);

    if (data.booking_id) {
      const card = document.getElementById(`booking-card-${data.booking_id}`);
      if (card) {

        const badge = card.querySelector('.status-badge');
        if (badge) {
          badge.innerText = data.new_status.charAt(0).toUpperCase() + data.new_status.slice(1);

          badge.className = 'badge text-dark status-badge';
          if (data.new_status === 'accepted') badge.classList.add('bg-success');
          else if (data.new_status === 'rejected' || data.new_status === 'cancelled') badge.classList.add('bg-danger');
          else if (data.new_status === 'pending') badge.classList.add('bg-info');
          else badge.classList.add('bg-secondary');
        }


        card.classList.add('animate__animated', 'animate__pulse');
        card.style.borderColor = "#f9b934";

        setTimeout(() => {
          card.classList.remove('animate__animated', 'animate__pulse');
          card.style.borderColor = "";
        }, 2000);


        if (data.action_urls) {
          const btnContainer = card.querySelector('.d-flex.flex-wrap.gap-2.mt-2');
          if (btnContainer) {
            btnContainer.innerHTML = '';


            if (data.new_status === 'accepted' && data.action_urls.schedule_url) {
              btnContainer.innerHTML = `<a href="${data.action_urls.schedule_url}" class="btn btn-success fw-bold shadow-sm animate__animated animate__zoomIn">Accept & Schedule</a>`;
            }

            else if (data.new_status === 'scheduled') {
              let html = '';
              if (data.is_provider && data.action_urls.start_meeting_url) {
                html += `<a href="${data.action_urls.start_meeting_url}" target="_blank" class="btn btn-primary fw-bold shadow-sm animate__animated animate__zoomIn me-2">Start Zoom</a>`;
              } else if (!data.is_provider && data.action_urls.join_meeting_url) {
                html += `<a href="${data.action_urls.join_meeting_url}" target="_blank" class="btn btn-info fw-bold shadow-sm animate__animated animate__zoomIn me-2">Join Zoom</a>`;
              } else if (!data.is_provider) {
                html += `<span class="badge bg-secondary me-2 animate__animated animate__fadeIn">Scheduled</span>`;
              }

              if (data.action_urls.chat_url) {
                html += `<a href="${data.action_urls.chat_url}" class="btn btn-info fw-bold shadow-sm animate__animated animate__zoomIn">Chat</a>`;
              }
              btnContainer.innerHTML = html;
            }

            else if (data.new_status === 'rejected') {
              btnContainer.innerHTML = `<span class="text-danger fw-bold animate__animated animate__fadeIn">Booking Rejected</span>`;
            }

            else if (data.new_status === 'cancelled') {
              btnContainer.innerHTML = `<span class="text-warning fw-bold animate__animated animate__fadeIn">Booking Cancelled</span>`;
            }
          }
        } else {

          if (data.new_status === 'accepted') {
            const body = card.querySelector('.card-body');
            if (!body.querySelector('.refresh-hint')) {
              const hint = document.createElement('div');
              hint.className = "alert alert-warning mt-2 refresh-hint animate__animated animate__fadeIn";
              hint.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Status changed. <a href="javascript:location.reload()" class="fw-bold">Refresh</a> to proceed.';
              body.appendChild(hint);
            }
          }
        }
      }
    }
  });
</script>

<style>
  .booking-card {
    border: 2px solid #F0E68C;
    background-color: #FFF8DC;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    color: #212529;
  }

  .booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  }

  .headings-color {
    color: #212529;
  }

  .waiting-text {
    color: #212529;
  }

  body.dark-mode .headings-color {
    color: #f5f5f5 !important;
  }

  body.dark-mode .booking-card {
    background-color: #1a1a1a;
    border: 2px solid #333;
    color: #e0e0e0;
  }

  body.dark-mode .booking-card:hover {
    box-shadow: 0 10px 25px rgba(255, 255, 255, 0.1);
  }

  body.dark-mode .waiting-text {
    color: #ccc;
  }



  .btn {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  .badge {
    font-size: 0.85rem;
    border-radius: 12px;
    padding: 0.35em 0.7em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .animate__animated {
    --animate-duration: 0.8s;
  }

  .star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    font-size: 2rem;
  }

  .star-rating input {
    display: none;
  }

  .star-rating label {
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s;
  }

  .star-rating input:checked~label,
  .star-rating label:hover,
  .star-rating label:hover~label {
    color: #ffc107;
  }

  body.dark-mode .modal-content {
    background-color: #1a1a1a;
    border: 1px solid #444;
    color: #e0e0e0;
  }

  body.dark-mode .modal-header,
  body.dark-mode .modal-footer {
    border-color: #333;
  }

  body.dark-mode .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
  }

  body.dark-mode .form-label {
    color: #e0e0e0;
  }

  body.dark-mode .form-control {
    background-color: #2a2a2a;
    border: 1px solid #444;
    color: #e0e0e0;
  }

  body.dark-mode .form-control:focus {
    background-color: #2a2a2a;
    border-color: #f1c40f;
    color: #fff;
  }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

<script>
  document.addEventListener("DOMContentLoaded", function () {
    window.addEventListener('bookingStatusChanged', function (e) {
      const data = e.detail;
      console.log("Booking Update Received:", data);

      if (data.booking_id) {
        const card = document.getElementById(`booking-card-${data.booking_id}`);
        if (card) {

          const badge = card.querySelector('.status-badge');
          if (badge) {
            badge.innerText = data.new_status.charAt(0).toUpperCase() + data.new_status.slice(1);


            badge.className = 'badge text-dark status-badge';
            if (data.new_status === 'accepted') badge.classList.add('bg-success');
            else if (data.new_status === 'rejected' || data.new_status === 'cancelled' || data.new_status === 'canceled') badge.classList.add('bg-danger');
            else if (data.new_status === 'pending') badge.classList.add('bg-warning');
            else if (data.new_status === 'scheduled') badge.classList.add('bg-primary');
            else badge.classList.add('bg-secondary');
          }


          card.classList.add('animate__animated', 'animate__pulse');
          card.style.borderColor = "#f9b934";

          setTimeout(() => {
            card.classList.remove('animate__animated', 'animate__pulse');
            card.style.borderColor = "";
          }, 2000);


          if (data.action_urls) {
            const btnContainer = card.querySelector('.d-flex.flex-wrap.gap-2.mt-2');
            if (btnContainer) {
              btnContainer.innerHTML = '';


              if (data.new_status === 'accepted') {
                let html = '';

                if (data.is_provider && data.action_urls.schedule_url) {
                  html += `<a href="${data.action_urls.schedule_url}" class="btn btn-primary fw-bold shadow-sm animate__animated animate__zoomIn me-2">Schedule Meeting</a>`;
                }
                if (data.action_urls.chat_url) {
                  html += `<a href="${data.action_urls.chat_url}" class="btn btn-info fw-bold shadow-sm animate__animated animate__zoomIn">Chat</a>`;
                }
                btnContainer.innerHTML = html;
              }

              else if (data.new_status === 'scheduled') {
                let html = '';
                if (data.is_provider && data.action_urls.start_meeting_url) {
                  html += `<a href="${data.action_urls.start_meeting_url}" target="_blank" class="btn btn-primary fw-bold shadow-sm animate__animated animate__zoomIn me-2">Start Zoom</a>`;
                } else if (!data.is_provider && data.action_urls.join_meeting_url) {
                  html += `<a href="${data.action_urls.join_meeting_url}" target="_blank" class="btn btn-primary fw-bold shadow-sm animate__animated animate__zoomIn me-2">Join Zoom</a>`;
                } else if (!data.is_provider) {
                  html += `<span class="badge bg-secondary me-2 animate__animated animate__fadeIn">Scheduled</span>`;
                }

                if (data.action_urls.chat_url) {
                  html += `<a href="${data.action_urls.chat_url}" class="btn btn-info fw-bold shadow-sm animate__animated animate__zoomIn">Chat</a>`;
                }
                btnContainer.innerHTML = html;
              }

              else if (data.new_status === 'rejected') {
                btnContainer.innerHTML = `<span class="text-danger fw-bold animate__animated animate__fadeIn">Booking Rejected</span>`;
              }
            }
          } else {

            if (data.new_status === 'accepted') {
              const body = card.querySelector('.card-body');
              if (!body.querySelector('.refresh-hint')) {
                const hint = document.createElement('div');
                hint.className = "alert alert-warning mt-2 refresh-hint animate__animated animate__fadeIn";
                hint.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Status changed. <a href="javascript:location.reload()" class="fw-bold">Refresh</a> to proceed.';
                body.appendChild(hint);
              }
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}