<!-- Platform Review Modal -->
{% if show_platform_review_modal %}
<div class="modal fade" id="platformReviewModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="platformReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header border-0 bg-theme text-dark">
                <h5 class="modal-title fw-bold" id="platformReviewModalLabel">âœ¨ Share Your Experience!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="lead mb-4">You've completed 3 meetings! ðŸŽ‰<br>How was your experience with SkillLink?</p>
                <form id="platformReviewForm">
                    <div class="mb-3">
                        <div class="rating-stars mb-3">
                            <i class="bi bi-star fs-2 star-rating" data-value="1"></i>
                            <i class="bi bi-star fs-2 star-rating" data-value="2"></i>
                            <i class="bi bi-star fs-2 star-rating" data-value="3"></i>
                            <i class="bi bi-star fs-2 star-rating" data-value="4"></i>
                            <i class="bi bi-star fs-2 star-rating" data-value="5"></i>
                        </div>
                        <input type="hidden" id="reviewRating" name="rating" value="0">
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control" id="reviewContent" rows="4"
                            placeholder="Tell us what you loved or how we can improve..." required></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-dark fw-bold py-2 rounded-pill">Submit Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    body.dark-mode .modal-content {
        background-color: #1e1e1e;
        border: 1px solid #444;
        color: #f5f5f5;
    }

    body.dark-mode .modal-header {
        background-color: #333;
        color: #fff !important;
        border-bottom: 1px solid #444;
    }

    body.dark-mode .modal-title {
        color: #fff !important;
    }

    body.dark-mode .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    body.dark-mode .form-control {
        background-color: #2b2b2b;
        color: #fff;
        border-color: #555;
    }

    body.dark-mode .form-control::placeholder {
        color: #aaa;
    }

    body.dark-mode .form-control:focus {
        background-color: #2b2b2b;
        color: #fff;
        border-color: #f39c12;
        box-shadow: 0 0 0 0.25rem rgba(243, 156, 18, 0.25);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var myModal = new bootstrap.Modal(document.getElementById('platformReviewModal'));
        myModal.show();

        // Star Rating Logic
        const stars = document.querySelectorAll('.star-rating');
        const ratingInput = document.getElementById('reviewRating');

        // Initialize stars (0 by default)
        updateStars(0);

        stars.forEach(star => {
            star.addEventListener('click', function () {
                const value = parseInt(this.getAttribute('data-value'));
                ratingInput.value = value;
                updateStars(value);
            });

            star.addEventListener('mouseover', function () {
                const value = parseInt(this.getAttribute('data-value'));
                highlightStars(value);
            });

            star.addEventListener('mouseout', function () {
                const value = parseInt(ratingInput.value);
                updateStars(value);
            });
        });

        function updateStars(value) {
            stars.forEach(s => {
                const sVal = parseInt(s.getAttribute('data-value'));
                if (sVal <= value) {
                    s.classList.remove('bi-star');
                    s.classList.add('bi-star-fill', 'text-warning');
                } else {
                    s.classList.remove('bi-star-fill', 'text-warning');
                    s.classList.add('bi-star');
                }
            });
        }

        function highlightStars(value) {
            stars.forEach(s => {
                const sVal = parseInt(s.getAttribute('data-value'));
                if (sVal <= value) {
                    s.classList.remove('bi-star');
                    s.classList.add('bi-star-fill', 'text-warning');
                } else {
                    s.classList.remove('bi-star-fill', 'text-warning');
                    s.classList.add('bi-star');
                }
            });
        }


        // Form Submission
        const form = document.getElementById('platformReviewForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const content = document.getElementById('reviewContent').value;
            const rating = parseInt(document.getElementById('reviewRating').value);

            // Validation: Rating Required
            if (rating === 0) {
                alert("Please select a star rating!");
                return;
            }

            fetch("{% url 'submit_platform_review' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ content: content, rating: rating })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        myModal.hide();
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endif %}