{% extends 'base.html' %}
{% block title %}Verify OTP - SkillLink{% endblock %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-center align-items-center vh-100">
  <div class="card otp-card shadow-lg p-4 animate__animated animate__fadeIn" style="max-width: 420px; width: 100%;">

    <!-- Header -->
    <div class="text-center mb-3">
      <!-- <img src="{% static 'images/logo.png' %}" alt="SkillLink Logo" width="80" class="mb-2"> -->
      <h3 class="fw-bold text-dark">OTP Verification</h3>
      <p class="text-muted small">Enter the OTP sent to <strong>{{ email }}</strong></p>
    </div>

    <!-- OTP Form -->
    <form method="POST" id="otpForm" class="animate__animated animate__fadeInUp">
      {% csrf_token %}
      <div class="mb-3">
        <input type="text" name="otp" maxlength="6" class="form-control text-center fw-bold fs-5 otp-input"
          placeholder="Enter OTP" required>
      </div>
      <button type="submit" class="btn btn-warning w-100 fw-bold shadow-sm hover-scale">
        Verify OTP
      </button>
    </form>

    <!-- Resend -->
    <p class="text-center mt-3 mb-1 fw-medium otp-text">
      Didn’t receive OTP?
      <span id="resendOtp"
        class="fw-bold text-warning1 text-decoration-underline cursor-pointer hover-scale d-inline-block ms-1">Resend</span>
    </p>

    <!-- Timer -->
    <p class="text-center text-muted small">
      OTP expires in <span id="timer" class="fw-bold">02:00</span>
    </p>
  </div>
</div>

<!-- Styles -->
<style>
  body {
    background: linear-gradient(135deg, #fdfbfb, #ebedee);
    font-family: 'Poppins', sans-serif;
  }

  /* Dark Mode Overrides */
  body.dark-mode {
    background: linear-gradient(135deg, #121212, #0d0d0d) !important;
    color: #e0e0e0;
  }

  .text-warning1 {
    color: #000 !important;
  }

  body.dark-mode .text-warning1 {
    color: #f1c40f !important;
  }

  .otp-card {
    border-radius: 20px;
    transition: transform 0.3s ease;
    background: linear-gradient(135deg, #fffdf5, #fef8e7);
    border: 2px solid #f6d365;
  }

  body.dark-mode .otp-card {
    background: #1e1e1e !important;
    border-color: #333 !important;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
  }

  body.dark-mode .text-dark {
    color: #fff !important;
  }

  body.dark-mode .text-muted {
    color: #aaa !important;
  }

  .otp-text {
    color: #333;
  }

  body.dark-mode .otp-text {
    color: #ccc !important;
  }

  .otp-input {
    letter-spacing: 0.4rem;
    border: 2px solid #FFD700;
    border-radius: 12px;
    transition: all 0.3s ease;
    background-color: #fff;
    color: #000;
  }

  body.dark-mode .otp-input {
    background-color: #2b2b2b;
    border-color: #555;
    color: #fff;
  }

  .otp-input:focus {
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    border-color: #f1c40f;
  }

  body.dark-mode .otp-input:focus {
    border-color: #f9b934;
    box-shadow: 0 0 10px rgba(249, 185, 52, 0.2);
  }

  .hover-scale {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .hover-scale:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  .hover-underline:hover {
    text-decoration: underline;
  }

  .animate__animated {
    animation-duration: 0.8s;
  }

  .cursor-pointer {
    cursor: pointer;
  }
</style>

<!-- Script -->
<script>
  // OTP Timer with persistence
  const backendRemaining = {{ remaining_seconds|default:600 }};
  let storedEndTime = sessionStorage.getItem('otpExpiry');
  let endTime;

  if (storedEndTime) {
    endTime = parseInt(storedEndTime);

    let currentRemaining = Math.floor((endTime - Date.now()) / 1000);

    if (Math.abs(currentRemaining - backendRemaining) > 10 || currentRemaining < 0) {
      endTime = Date.now() + (backendRemaining * 1000);
      sessionStorage.setItem('otpExpiry', endTime);
    }
  } else {
    endTime = Date.now() + (backendRemaining * 1000);
    sessionStorage.setItem('otpExpiry', endTime);
  }

  function updateTimer() {
    let now = Date.now();
    let timeLeft = Math.floor((endTime - now) / 1000);
    const timerEl = document.getElementById('timer');
    const verifyBtn = document.querySelector('#otpForm button');

    if (timeLeft <= 0) {
      if (typeof countdown !== 'undefined') clearInterval(countdown);
      timerEl.textContent = "Expired!";
      timerEl.classList.add('text-danger');
      if (verifyBtn) {
        verifyBtn.disabled = true;
        verifyBtn.style.opacity = '0.5';
      }
      return;
    }

    const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const seconds = String(timeLeft % 60).padStart(2, '0');
    timerEl.textContent = `${minutes}:${seconds}`;
  }

  let countdown = setInterval(updateTimer, 1000);
  updateTimer();

  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  // Resend OTP
  document.getElementById('resendOtp').addEventListener('click', function () {
    const resendBtn = this;
    resendBtn.style.pointerEvents = 'none';
    resendBtn.style.opacity = '0.5';

    fetch("{% url 'resend_otp' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('✅ OTP resent! Check your email.');
          // Reset Timer
          endTime = Date.now() + (600 * 1000); // 10 minutes
          sessionStorage.setItem('otpExpiry', endTime);

          clearInterval(countdown);
          countdown = setInterval(updateTimer, 1000);
          updateTimer();

          const verifyBtn = document.querySelector('#otpForm button');
          if (verifyBtn) {
            verifyBtn.disabled = false;
            verifyBtn.style.opacity = '1';
          }
          const timerEl = document.getElementById('timer');
          if (timerEl) {
            timerEl.classList.remove('text-danger');
          }
        } else {
          alert('❌ Error: ' + data.message);
        }
      })
      .finally(() => {
        resendBtn.style.pointerEvents = 'auto';
        resendBtn.style.opacity = '1';
      });
  });

  // Clear timer on success (handled by being redirected away, but good practice)
  {% if messages %}
  {% for message in messages %}
  {% if 'success' in message.tags %}
  sessionStorage.removeItem('otpExpiry');
  {% endif %}
  {% endfor %}
  {% endif %}
</script>
{% endblock %}